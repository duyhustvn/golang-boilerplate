# High Availability

# Config replication stream

## On all nodes

- Config PostgreSQL
    
    ```sql
    listen_addresses = '*'
    ```
    
- Update pg_hba.conf
    
    ```sql
    # Database administrative login by Unix domain socket
    # local   all             postgres                                peer
    
    # TYPE  DATABASE        USER            ADDRESS                 METHOD
    
    # "local" is for Unix domain socket connections only
    local   all             all                                     scram-sha-256
    # IPv4 local connections:
    host    all             all             127.0.0.1/32            scram-sha-256
    # IPv6 local connections:
    host    all             all             ::1/128                 scram-sha-256
    # Allow replication connections from localhost, by a user with the
    # replication privilege.
    local   replication     all                                     scram-sha-256
    host    replication     all             127.0.0.1/32            scram-sha-256
    host    replication     all             ::1/128                 scram-sha-256
    host    replication     repl            192.168.56.0/24         scram-sha-256
    host    all             postgres        192.168.56.0/24         scram-sha-256
    host    all             pgpool          192.168.56.0/24         scram-sha-256
    
    ```
    

## On the primary node

- Create PostgreSQL user repl
    
    ```bash
    sudo -u postgres psql -c "CREATE ROLE repl WITH REPLICATION LOGIN PASSWORD 'replPasswd'"
    ```
    
- Change password of user postgres
    
    ```bash
    sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgresPasswd'"
    ```
    
- Create PostgreSQL user pgpool
    
    ```bash
    sudo -u postgres psql -c "CREATE ROLE pgpool WITH LOGIN PASSWORD 'pgpoolPasswd'"
    ```
    

## On the standby node

- Stop PostgreSQL
    
    ```bash
    sudo systemctl stop postgresql@16-main.service
    ```
    
- Remove PostgreSQL’s data folder
    
    ```bash
    sudo rm -rf /var/lib/postgresql/16/main
    ```
    
- Run pg_basebackup
    
    ```bash
    sudo -u postgres /usr/lib/postgresql/16/bin/pg_basebackup \
    -h 192.168.56.111 \
    -U repl -p 5432 \
    -D /var/lib/postgresql/16/main \
    -X stream -v -R -C -S 192_168_56_113
    ```
    
    The flags used are significant
    
    - `-h` Specifies the hostname or IP address of the primary server
    - `-D` Defines the target data directory on the standby where the backup will be stored
    - `-U` Designates the replication user (`repl`) created earlier.
    - `-P` Enables progress reporting during the backup process
    - `-v` Activates verbose mode for detailed output
    - `-R` Create standby.signal **file inside the data folder to mark the server as the standby server
    - `-C` Create a replication slot
    - `-S` Name of the replication slot
    
    You should see the output like this
    
    ```bash
    pg_basebackup: initiating base backup, waiting for checkpoint to complete
    pg_basebackup: checkpoint completed
    pg_basebackup: write-ahead log start point: 0/9000028 on timeline 1
    pg_basebackup: starting background WAL receiver
    pg_basebackup: created replication slot "192_168_56_113"
    pg_basebackup: write-ahead log end point: 0/9000100
    pg_basebackup: waiting for background process to finish streaming ...
    pg_basebackup: syncing data to disk ...
    pg_basebackup: renaming backup_manifest.tmp to backup_manifest
    pg_basebackup: base backup completed
    ```
    

File postgresql.auto.conf will be updated with the primary connection information

```bash
cat /var/lib/postgresql/16/main/postgresql.auto.conf 
# Do not edit this file manually!
# It will be overwritten by the ALTER SYSTEM command.
primary_conninfo = 'user=repl 
                    password=replPasswd 
                    channel_binding=prefer 
                    host=192.168.56.111 
                    port=5432 
                    sslmode=prefer 
                    sslnegotiation=postgres 
                    sslcompression=0 
                    sslcertmode=allow 
                    sslsni=1 
                    ssl_min_protocol_version=TLSv1.2 
                    gssencmode=prefer 
                    krbsrvname=postgres 
                    gssdelegation=0 
                    target_session_attrs=any 
                    load_balance_hosts=disable'
primary_slot_name = '192_168_56_113'
```

Replication slot

```bash
postgres=# select * from pg_replication_slots;
   slot_name    | plugin | slot_type | datoid | database | temporary | active | active_pid | xmin | catalog_xmin | restart_lsn | confirmed_flush_lsn | wal_status | safe_wal_size | two_phase | conflicting 
----------------+--------+-----------+--------+----------+-----------+--------+------------+------+--------------+-------------+---------------------+------------+---------------+-----------+-------------
 192_168_56_113 |        | physical  |        |          | f         | f      |            |      |              | 0/9000000   |                     | reserved   |               | f         | 
(1 row)
```

- Start PostgreSQL
    
    ```bash
    sudo systemctl start postgresql@16-main.service
    ```
    

# Config failover

In case primary node is down, standby node 1 will become master and standby node 2 will follow the new master

## On the primary node

- Stop the master node

## On the standby node 1

- Promote the standby server
    
    ```bash
    sudo -u postgres psql -c "SELECT pg_promote()"
    ```
    

## On the standby node 2

- Promote the standby server
    
    ```bash
    sudo -u postgres psql -c "SELECT pg_promote()"
    ```
    
- Stop PostgreSQL
    
    ```bash
    sudo systemctl stop postgresql@16-main.service
    ```
    
- Remove PostgreSQL’s data folder
    
    ```bash
    sudo rm -rf /var/lib/postgresql/16/main
    ```
    
- Run pg_basebackup
    
    ```bash
    sudo -u postgres /usr/lib/postgresql/16/bin/pg_basebackup \
    -h 192.168.56.112 \
    -U repl -p 5432 \
    -D /var/lib/postgresql/16/main \
    -X stream -v -R -C -S 192_168_56_113
    ```
    
- Start PostgreSQL
    
    ```bash
    sudo systemctl start postgresql@16-main.service
    ```
    

## In case master 1 is up again

- Remove PostgreSQL’s data folder
    
    ```bash
    sudo rm -rf /var/lib/postgresql/16/main
    ```
    
- Run pg_basebackup
    
    ```bash
    sudo -u postgres /usr/lib/postgresql/16/bin/pg_basebackup \
    -h 192.168.56.112 \
    -U repl -p 5432 \
    -D /var/lib/postgresql/16/main \
    -X stream -v -R -C -S 192_168_56_111
    ```
    
- Start PostgreSQL
    
    ```bash
    sudo systemctl start postgresql@16-main.service
    ```