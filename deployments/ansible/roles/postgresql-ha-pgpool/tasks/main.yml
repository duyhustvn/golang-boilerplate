#SPDX-License-Identifier: MIT-0
---
# tasks file for roles/postgresql-ha-pgpool2

- block:
    - name: Install PostgreSQL
      include_tasks: install/install_postgresql_debian.yml
      when: ansible_os_family == "Debian"

    - name: Install PostgreSQL
      include_tasks: install/install_postgresql_redhat.yml
      when: ansible_os_family == "RedHat"
  tags: [ install_postgresql, rc_all ]

- block:
    - name: Install Pgpool2
      include_tasks: install/install_pgpool2_debian.yml
      when: ansible_os_family == "Debian"

    - name: Install Pgpool2
      include_tasks: install/install_pgpool2_redhat.yml
      when: ansible_os_family == "RedHat"
  tags: [ install_pgpool2, rc_all ]

- block:
    - name: Init PostgreSQL
      include_tasks: psql/init_psql.yml
      when: ansible_os_family == "RedHat" and inventory_hostname == "node-db-01"
  tags: [ init_psql, rc_all ]

- block:
    - name: Config ssh between servers
      include_tasks: ssh/setup_ssh.yml
  tags: [ config_ssh, rc_all ]

- block:
    - name: Config PostgreSQL 
      include_tasks: psql/config_psql.yml
  tags: [ config_psql, rc_all ]

- block:
    - name: Config pgpool
      include_tasks: pgpool2/config_pgpool.yml
  tags: [ config_pgpool, rc_all ]

- block:
    - name: Deploy pgpool exporter
      include_tasks: pgpool2/exporter.yml
  tags: [ deploy_exporter, rc_all ]

# - block:
#     - name: Recover standby nodes
#       include_tasks: recover_standby.yml
#   when: inventory_hostname == "node-db-01"
#   tags: [ recover_standby, rc_all ]

- block:
    - name: Update pg_hba of PostgreSQL
      include_tasks: psql/update_pghba.yml
  tags: [ update_pghba ]

- block:
    - name: Update pool_hba of Pgpool
      include_tasks: pgpool2/update_pool_hba.yml
  notify: Restart PgPool
  tags: [ update_pool_hba ]

- block:
    - name: Grant privilege
      include_tasks: psql/grant_user.yml
  when: inventory_hostname == "node-db-01"
  tags: [ grant_user ]

- block:
  - name: Config Pgpool
    template:
      src: pgpool2/pgpool.conf.j2
      dest: '{{ pgpool_config_dir }}/pgpool.conf'
      mode: '0640'
      owner: root
      group: postgres
    notify: Restart PgPool
  tags: [ update_pool_config ]
